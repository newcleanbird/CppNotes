# 函数调用
## 函数栈帧（Stack Frame）
在大多数现代计算机体系结构中，函数调用的实现依赖于栈（stack）。每次函数调用时，都会在栈上创建一个新的栈帧（stack frame），用于存储函数的局部变量、函数参数、返回地址等信息。

栈帧的布局通常包括：
- 函数参数：调用者传递给函数的参数按一定规则（通常是从右到左）压入栈中。
- 返回地址：调用函数后应继续执行的下一条指令的地址。在函数返回前，控制权转移回此地址。
- 局部变量：函数内部声明的变量存储在栈上。
- 保存的寄存器：某些情况下，为了保护调用者环境，会将当前函数使用到的一些寄存器的值保存在栈上。

## 调用约定（Calling Convention）
不同的编程语言和编译器可能会有不同的调用约定，规定了函数调用时参数如何传递（寄存器或栈）、哪一方负责清理栈（调用者还是被调用者）、返回值如何传递等。常见的调用约定有cdecl、stdcall、fastcall等。

## 编译器的角色
- 名字修饰（Name Mangling）：由于C++支持函数重载，编译器需要一种方式来区分具有相同名字但参数类型或数量不同的函数。这通过名字修饰（也称作名称重整）实现，为每个函数生成一个唯一的内部名称，该名称包含了函数名、参数类型等信息。

- 虚函数表（VTable）：对于C++中的虚函数，编译器会在类的实例中添加一个指向虚函数表的指针。虚函数表是一个函数指针数组，包含了类及其基类中所有虚函数的地址。这允许在运行时动态决定调用哪个函数版本，支持多态性。

- 模板实例化：对于模板函数，编译器在遇到具体类型实例化时，会生成具体的函数代码。这意味着每个不同的类型参数组合都会导致编译器生成独立的函数代码。

## 寄存器的角色
- EIP/EIP（Instruction Pointer）：在x86架构中，EIP寄存器指向当前正在执行的指令地址。函数调用时，调用函数的下一条指令地址（即返回地址）会被压栈，EIP被设置为被调用函数的入口地址。

- ESP/EBP（Stack Pointer and Base Pointer）：ESP指向栈顶，EBP指向栈帧的底部。函数调用时，EBP通常保存当前栈帧的顶部地址，然后ESP减去一定的空间为新栈帧腾出位置。

## 参数传递
C++支持多种参数传递方式，包括值传递、引用传递、指针传递等。编译器根据函数定义和调用约定决定如何实际执行这些传递：

- 值传递：实际参数的副本被压入栈或存储在寄存器中传递给函数。
- 引用传递：传递实际参数的引用（即内存地址），允许函数直接修改原数据。
- 指针传递：与引用传递相似，但更底层，提供了对裸内存地址的操作。

## 返回值处理
- 基本类型和指针：直接通过寄存器（如EAX/RAX在x86架构中）或栈返回。
- 复杂类型：对于较大的对象或结构体，通常会返回一个指向已分配内存（堆或栈）的指针或引用，而不是直接复制整个对象。

## 函数重载与解析
C++编译器在编译时期通过类型检查和名字修饰来解析函数调用，确定调用哪一个重载版本。这涉及到类型匹配、类型转换规则以及模板特化。

## 异常处理
虽然不是直接与函数调用机制相关，但C++的异常处理机制会影响函数调用的流程。当函数抛出异常时，编译器会生成额外的代码来维护一个未处理异常的调用链，直到找到适当的catch块或导致程序终止。

## 函数调用过程
1. 参数传递：根据调用约定，参数被压入栈或存入寄存器。
2. 压入返回地址：调用指令执行前，当前指令的下一条指令地址被压入栈中。
3. 栈帧建立：调整ESP，为局部变量等预留空间，并可能保存EBP。
4. 执行函数体：控制权转移到被调用函数的入口地址。
5. 返回值处理：函数通过指定的机制（如EAX寄存器在x86架构中）返回值。
6. 栈帧销毁：恢复EBP（如果有保存的话），调整ESP回收栈空间。
7. 返回调用点：从栈顶弹出返回地址到EIP，控制权回到调用者。

## main函数调用
### 在main执行之前和之后执行的代码可能是什么？
1. main函数执行之前，主要就是初始化系统相关资源：
- 设置栈指针
- 初始化静态static变量和global全局变量，即.data段的内容
- 将未初始化部分的全局变量赋初值：数值型short，int，long等为0，bool为FALSE，指针为NULL等等，即.bss段的内容
- 全局对象初始化，在main之前调用构造函数，这是可能会执行前的一些代码
- 将main函数的参数argc，argv等传递给main函数，然后才真正运行main函数
__attribute__((constructor))

2. main函数执行之后：
全局对象的析构函数会在main函数之后执行；
可以用 atexit 注册一个函数，它会在main 之后执行; atexit()函数注册了一个在正常程序终止时调用的函数。
__attribute__((destructor))