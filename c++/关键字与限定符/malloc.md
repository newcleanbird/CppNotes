# malloc

malloc是一个来自C语言的函数，用于动态分配内存，尽管在C++中不鼓励直接使用它（更推荐使用new操作符），但为了兼容性和某些特定情况，C++仍然保留了这个函数。

## 作用

在内存的动态存储区中分配一个长度为size的连续空间。此函数的返回值是分配区域的起始地址，或者说，此函数是一个指针型函数，返回的指针指向该分配域的开头位置。

## 使用malloc

### 头文件

```cpp
#include <stdlib.h>或#include<malloc.h>
```

### 函数原型

```cpp
void* malloc(size_t size);
```

参数说明
size_t size：要分配的内存大小，以字节为单位。size_t是一个无符号整数类型，通常足够大以表示程序可能需要分配的任何内存块的大小。

### 返回值

- 如果分配成功，malloc返回一个指向分配到的内存起始地址的指针。
- 如果分配失败（例如，没有足够的可用内存），malloc返回NULL。

在以前malloc返回的是char型指针，新的ANSIC标准规定，该函数返回为void型指针。
void*表示未确定类型1的指针。C,C++规定，void* 类型可以通过类型转换强制转换为任何其它类型的指针，因此必要时要进行强制类型转换。

```cpp
char *str = (char *) malloc(15);//定义一个指向char（空间大小为15个字节）的指针
```

如果分配成功则返回指向被分配内存的指针(此存储区中的初始值不确定)，否则返回空指针NULL。

### 释放内存

当内存不再使用时，应使用free()函数将内存块释放。
注：　　
使用malloc分配的内存空间在虚拟地址空间上是连续的,即外部使用起来是连续的，可以对指针进行运算而且结果正确。但是转换到物理内存空间上有可能是不连续的,因为有可能相邻的两个字节是在不同的物理分页上；

### 使用示例

```cpp
#include <cstdlib> // 或#include <malloc.h>，取决于编译器环境

int main() {
    int *ptr = (int*)malloc(sizeof(int)); // 申请一个int大小的内存
    if (ptr == NULL) {
        std::cout << "Memory allocation failed\n";
        return 1;
    }
    
    *ptr = 42; // 在分配的内存中存储一个值
    std::cout << "Value: " << *ptr << "\n";
    
    free(ptr); // 释放内存
    return 0;
}
```

## 注意事项

- 类型安全：与C++的new操作符不同，malloc不执行构造函数，也不对返回的指针类型进行检查。因此，使用malloc后通常需要进行类型转换，并且程序员需确保正确管理内存和类型安全。

- 内存初始化：malloc分配的内存内容是未定义的，可能包含之前分配在此处的数据残余。如果需要初始化为特定值，需要手动设置。

- 释放内存：使用malloc分配的内存必须用free函数释放。忘记释放会导致内存泄漏。

- 异常安全：C++中的new操作符可以与异常处理机制结合，提供更好的错误处理。而直接使用malloc时，需要手动检查分配是否成功并处理错误。

- 现代C++实践：虽然了解malloc及其工作原理对于理解底层内存管理有帮助，但在现代C++编程中，更推荐使用智能指针（如std::unique_ptr、std::shared_ptr）和容器类来自动管理内存，以及使用new和delete操作符进行显式内存管理，以提高代码的安全性和可维护性。
